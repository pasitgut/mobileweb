<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KKU Cinematic Editorial - Lab 02</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&family=Figtree:wght@300;500;800&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f2f2f2;
            --text-color: #1a1a1a;
            --accent-color: #c0392b; /* สีอิฐเข้ม */
            --card-bg: rgba(255, 255, 255, 0.6);
            --glass-border: 1px solid rgba(255, 255, 255, 0.4);
            --noise-url: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)" opacity="0.05"/%3E%3C/svg%3E');
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Sarabun', sans-serif;
            overflow-x: hidden;
            line-height: 1.6;
            position: relative;
        }

        /* --- Global Noise Overlay (Film Grain Effect) --- */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: var(--noise-url);
            pointer-events: none;
            z-index: 9999;
        }

        /* --- Unique Floating Header --- */
        header {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1200px;
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 50px;
            border: var(--glass-border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        header .logo-wrapper {
            display: flex;
            align-items: center;
        }

        nav ul {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        nav a {
            color: var(--text-color);
            text-decoration: none;
            font-family: 'Figtree', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            white-space: nowrap; /* ป้องกันข้อความตกบรรทัด */
        }

        nav a::after {
            content: '';
            position: absolute;
            bottom: -2px; left: 0; width: 0%; height: 2px;
            background: var(--accent-color);
            transition: width 0.3s;
        }

        nav a:hover::after { width: 100%; }

        /* --- WebGL Hero Section (Updated) --- */
        #gallery-container {
            width: 100%;
            height: 100vh;
            /* Support mobile browsers address bar */
            height: 100dvh; 
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: transparent; 
            overflow: hidden;
        }
        
        #gallery-container canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* --- "Editorial" Layout Structure --- */
        .editorial-section {
            display: flex;
            flex-wrap: wrap;
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 5%;
            position: relative;
            z-index: 10;
        }

        /* Sticky Title on the Left */
        .sticky-col {
            flex: 0 0 300px; /* Fixed width */
            position: sticky;
            top: 150px;
            height: fit-content;
            padding-right: 40px;
            margin-bottom: 50px;
        }

        .sticky-col h2 {
            font-family: 'Playfair Display', serif;
            font-size: 4rem;
            line-height: 1;
            color: var(--text-color);
            margin-bottom: 20px;
        }
        
        .sticky-col .subtitle {
            font-family: 'Figtree', sans-serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent-color);
            display: block;
            margin-bottom: 15px;
        }

        .sticky-col p {
            font-size: 1rem;
            color: #666;
            line-height: 1.8;
        }

        /* Content Column on the Right */
        .content-col {
            flex: 1;
            min-width: 300px;
        }

        /* --- Mosaic/Masonry Grid Style --- */
        .mosaic-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }

        .location-card {
            background: var(--card-bg);
            border: var(--glass-border);
            padding: 20px;
            border-radius: 0; /* Square edges for editorial look */
            transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            position: relative;
            overflow: hidden;
        }
        
        .location-card:hover {
            transform: translateY(-10px);
            background: rgba(255,255,255,0.9);
        }

        /* Unique Grid Spans */
        .location-card:nth-child(1) {
            grid-column: span 2; /* Full width */
        }
        .location-card:nth-child(2) {
            grid-row: span 2; /* Tall vertical */
        }
        
        .card-image-wrap {
            width: 100%;
            height: 250px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .location-card:nth-child(1) .card-image-wrap { height: 400px; }
        .location-card:nth-child(2) .card-image-wrap { height: 500px; }

        .card-image-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.7s ease;
        }

        .location-card:hover .card-image-wrap img {
            transform: scale(1.1);
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-family: 'Figtree', sans-serif;
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
        }

        .location-card h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .mini-thumbs {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        .mini-thumbs img {
            width: 50px; height: 50px;
            object-fit: cover;
            border-radius: 50%; /* Circular thumbnails */
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        .mini-thumbs img:hover { opacity: 1; }

        /* --- Minimalist Form --- */
        .form-container {
            background: #fff;
            padding: 60px;
            position: relative;
        }
        
        .form-container::before {
            content: '';
            position: absolute;
            top: -10px; left: -10px; right: -10px; bottom: -10px;
            border: 1px solid var(--text-color);
            z-index: -1;
            opacity: 0.2;
        }

        .input-group {
            position: relative;
            margin-bottom: 30px;
        }

        .input-group input, 
        .input-group textarea {
            width: 100%;
            padding: 10px 0;
            border: none;
            border-bottom: 2px solid #ddd;
            background: transparent;
            font-family: 'Sarabun', sans-serif;
            font-size: 1.1rem;
            transition: border-color 0.3s;
        }

        .input-group input:focus, 
        .input-group textarea:focus {
            outline: none;
            border-bottom-color: var(--accent-color);
        }

        .input-group label {
            position: absolute;
            top: 10px;
            left: 0;
            color: #999;
            pointer-events: none;
            transition: 0.3s ease all;
            font-size: 1rem;
        }

        .input-group input:focus ~ label,
        .input-group input:valid ~ label,
        .input-group textarea:focus ~ label,
        .input-group textarea:valid ~ label {
            top: -20px;
            font-size: 0.8rem;
            color: var(--accent-color);
        }

        .btn-editorial {
            background: var(--text-color);
            color: #fff;
            border: none;
            padding: 15px 40px;
            font-family: 'Figtree', sans-serif;
            font-weight: 800;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-editorial:hover {
            background: var(--accent-color);
            transform: skewX(-10deg);
        }

        /* --- Footer --- */
        footer {
            background: #111;
            color: #fff;
            padding: 80px 5%;
            text-align: center;
        }
        
        .footer-logo canvas { margin-bottom: 20px; }

        /* --- Responsive Improvements --- */
        @media (max-width: 900px) {
            header {
                width: 95%;
                top: 10px;
                flex-direction: column; /* Stack logo and nav */
                padding: 15px;
                gap: 15px;
                border-radius: 20px;
            }

            nav ul {
                gap: 20px;
                font-size: 0.9rem;
            }

            .editorial-section { 
                flex-direction: column; 
                padding: 60px 20px; /* Reduce padding */
            }

            .sticky-col { 
                position: relative; 
                top: 0; 
                width: 100%; 
                margin-bottom: 40px; 
                text-align: center; /* Center align title on mobile */
                padding-right: 0;
            }

            .sticky-col h2 { 
                font-size: 2.5rem; /* Smaller Font */
            }
            
            .content-col {
                min-width: 100%;
            }

            .mosaic-grid { 
                grid-template-columns: 1fr; /* Single column */
                gap: 20px;
            }

            /* Reset Grid Spans for Mobile */
            .location-card:nth-child(1) { grid-column: auto; }
            .location-card:nth-child(2) { grid-row: auto; }

            /* Consistent Image Height on Mobile */
            .location-card:nth-child(1) .card-image-wrap,
            .location-card:nth-child(2) .card-image-wrap,
            .card-image-wrap { 
                height: 220px; 
            }

            .form-container {
                padding: 30px 20px;
            }
            
            .btn-editorial {
                width: 100%; /* Full width button */
            }
            
            #gallery-container { 
                padding-top: 100px; /* More space for header */
            }
        }
    </style>
</head>
<body>

    <!-- 1. Floating Header -->
    <header>
        <div class="logo-wrapper">
            <!-- Scale down canvas for mobile via CSS/Attributes if needed, handled in JS mostly -->
            <canvas id="logoCanvas" width="160" height="40"></canvas>
        </div>
        <nav>
            <ul>
                <li><a href="#gallery-container">Guide</a></li>
                <li><a href="#landmarks">Landmarks</a></li>
                <li><a href="#contact">Add New</a></li>
            </ul>
        </nav>
    </header>

    <!-- 2. WebGL Hero (Cinematic) -->
    <main id="gallery-container"></main>

    <!-- 3. Student Info Block (Minimalist) - UPDATED -->
    <div style="text-align: center; padding: 60px 20px; position: relative; z-index: 5;">
        <p style="font-family: 'Figtree'; text-transform: uppercase; letter-spacing: 2px; font-size: 0.8rem; color: #888;">Curated By</p>
        <h3 style="font-size: 1.8rem; margin: 15px 0; font-family: 'Sarabun', sans-serif; font-weight: 600;">พสิษฐ์ ผลวิเศษพรสุข</h3>
        <p style="color: #666; font-family: 'Figtree', sans-serif; letter-spacing: 1px;">ID: 663380020-7 &mdash; College of Computing</p>
        <div style="width: 2px; height: 40px; background: var(--accent-color); margin: 30px auto 0;"></div>
    </div>

    <!-- 4. Locations Section (Editorial/Sticky Layout) -->
    <section id="landmarks" class="editorial-section">
        <div class="sticky-col">
            <span class="subtitle">01 — Exploration</span>
            <h2>Campus<br>Icons</h2>
            <p>ค้นพบแลนด์มาร์คสำคัญของมหาวิทยาลัยขอนแก่น ผ่านมุมมองใหม่และการออกแบบที่แตกต่าง</p>
        </div>
        
        <div class="content-col">
            <div class="mosaic-grid">
                
                <article class="location-card">
                    <div class="card-image-wrap">
                        <img src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=800&auto=format&fit=crop" alt="Lake">
                    </div>
                    <div class="card-meta"><span>Nature</span> <span>01</span></div>
                    <h3>Sithan Lake</h3>
                    <p>บึงสีฐาน จุดเช็คอินยอดฮิตสำหรับชมพระอาทิตย์ตกดินและออกกำลังกาย</p>
                    <div class="mini-thumbs">
                        <img src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=100">
                        <img src="https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=100">
                    </div>
                </article>

                <article class="location-card">
                    <div class="card-image-wrap">
                        <img src="https://images.unsplash.com/photo-1507842217121-9d5908b04c42?w=800&auto=format&fit=crop" alt="Library">
                    </div>
                    <div class="card-meta"><span>Education</span> <span>02</span></div>
                    <h3>Central Library</h3>
                    <p>แหล่งเรียนรู้ที่ทันสมัย (KKU Library) พร้อม Co-working space</p>
                    <div class="mini-thumbs">
                        <img src="https://images.unsplash.com/photo-1521587760476-6c12a4b040da?w=100">
                        <img src="https://images.unsplash.com/photo-1481627834876-b7833e8f5570?w=100">
                    </div>
                </article>

                <article class="location-card">
                    <div class="card-image-wrap">
                        <img src="https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=800&auto=format&fit=crop" alt="Complex">
                    </div>
                    <div class="card-meta"><span>Lifestyle</span> <span>03</span></div>
                    <h3>KKU Complex</h3>
                    <p>ศูนย์รวมอาหารและบริการครบวงจร เป็นจุดนัดพบสำคัญ</p>
                    <div class="mini-thumbs">
                        <img src="https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=100">
                    </div>
                </article>

                 <article class="location-card">
                    <div class="card-image-wrap">
                        <img src="https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&auto=format&fit=crop" alt="Computing">
                    </div>
                    <div class="card-meta"><span>Technology</span> <span>04</span></div>
                    <h3>Computing College</h3>
                    <p>ตึกวิทยาลัยการคอมพิวเตอร์ แหล่งกำเนิดนวัตกรรม AI และเทคโนโลยี</p>
                    <div class="mini-thumbs">
                        <img src="https://images.unsplash.com/photo-1531482615713-2afd69097998?w=100">
                    </div>
                </article>

            </div>
        </div>
    </section>

    <!-- 5. Form Section (Editorial Layout) -->
    <section id="contact" class="editorial-section" style="background: #fff;">
        <div class="sticky-col">
            <span class="subtitle">02 — Contribution</span>
            <h2>Recommend<br>A Place</h2>
            <p>ร่วมเป็นส่วนหนึ่งในการแนะนำสถานที่น่าสนใจภายในมหาวิทยาลัย</p>
        </div>
        <div class="content-col">
            <div class="form-container">
                <form action="https://api.web3forms.com/submit" method="POST">
                    <input type="hidden" name="access_key" value="YOUR_ACCESS_KEY_HERE">

                    <div class="input-group">
                        <input type="text" name="place" required>
                        <label>Place Name (ชื่อสถานที่)</label>
                    </div>

                    <div class="input-group">
                        <textarea name="details" rows="3" required></textarea>
                        <label>Description (รายละเอียด)</label>
                    </div>

                    <div class="input-group">
                        <input type="url" name="image_url">
                        <label>Image URL (ลิงก์รูปภาพ)</label>
                    </div>

                    <button type="submit" class="btn-editorial">Submit Data</button>
                </form>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="footer-logo">
            <canvas id="footerLogoCanvas" width="50" height="50"></canvas>
        </div>
        <p>&copy; 2025 KKU Editorial Guide. <br>Design Concept: Modern Editorial.</p>
    </footer>

    <!-- Scripts -->
    <script type="module">
        import { Renderer, Camera, Transform, Plane, Mesh, Program, Texture } from 'https://cdn.jsdelivr.net/npm/ogl@0.0.32/dist/ogl.mjs';

        // --- 1. Unique Logo Animation (FIXED) ---
        function initLogo(canvasId, color = "#1a1a1a") {
            const canvas = document.getElementById(canvasId);
            if(!canvas) return;
            
            // Fix blur on high DPI screens AND fix zero-width issue
            const dpr = window.devicePixelRatio || 1;
            
            // Use logical width/height from attributes to ensure stability
            const logicalWidth = parseInt(canvas.getAttribute("width")) || 160;
            const logicalHeight = parseInt(canvas.getAttribute("height")) || 40;

            // Enforce logical size via CSS to prevent collapse
            canvas.style.width = `${logicalWidth}px`;
            canvas.style.height = `${logicalHeight}px`;

            // Set internal buffer size
            canvas.width = logicalWidth * dpr;
            canvas.height = logicalHeight * dpr;
            
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            
            let frame = 0;

            function draw() {
                // Clear using logical coordinates
                ctx.clearRect(0, 0, logicalWidth, logicalHeight);
                
                ctx.font = "800 20px Figtree";
                ctx.fillStyle = color;
                // Coordinates adjusted for 160x40 canvas
                ctx.fillText("KKU GUIDE", 52, 28);

                const cx = 22;
                const cy = 20;

                ctx.save();
                ctx.translate(cx, cy);

                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.lineCap = "round";
                const size = 8 + Math.sin(frame * 0.02) * 2; 
                
                ctx.beginPath(); 
                ctx.moveTo(-size, -size/1.5); 
                ctx.lineTo(-size, -size); 
                ctx.lineTo(-size/1.5, -size); 
                ctx.stroke();

                ctx.beginPath(); 
                ctx.moveTo(size, size/1.5); 
                ctx.lineTo(size, size); 
                ctx.lineTo(size/1.5, size); 
                ctx.stroke();

                ctx.fillStyle = "#c0392b";
                ctx.beginPath();
                ctx.arc(0, 0, 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.rotate(frame * 0.015); 
                ctx.fillStyle = color;
                ctx.globalAlpha = 0.5;
                ctx.beginPath();
                ctx.arc(14, 0, 2, 0, Math.PI * 2);
                ctx.fill();

                ctx.restore();
                
                frame++;
                requestAnimationFrame(draw);
            }
            draw();
        }
        
        // --- 2. WebGL Gallery ---
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        function lerp(p1, p2, t) { return p1 + (p2 - p1) * t; }
        
        function createTextTexture(gl, text, font = '800 50px Playfair Display', color = '#1a1a1a') { 
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            context.font = font;
            const metrics = context.measureText(text);
            const textWidth = Math.ceil(metrics.width);
            const textHeight = Math.ceil(parseInt(font, 10) * 1.2);
            canvas.width = textWidth + 20;
            canvas.height = textHeight + 20;
            context.font = font;
            context.fillStyle = color;
            context.textBaseline = 'middle';
            context.textAlign = 'center';
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.fillText(text, canvas.width / 2, canvas.height / 2);
            const texture = new Texture(gl, { generateMipmaps: false });
            texture.image = canvas;
            return { texture, width: canvas.width, height: canvas.height };
        }

        class Title {
            constructor({ gl, plane, renderer, text, textColor = '#1a1a1a', font }) {
                this.gl = gl;
                this.plane = plane;
                this.renderer = renderer;
                this.text = text;
                this.textColor = textColor;
                this.font = font;
                this.createMesh();
            }
            createMesh() {
                const { texture, width, height } = createTextTexture(this.gl, this.text, this.font, this.textColor);
                const geometry = new Plane(this.gl);
                const program = new Program(this.gl, {
                    vertex: `attribute vec3 position; attribute vec2 uv; uniform mat4 modelViewMatrix; uniform mat4 projectionMatrix; varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
                    fragment: `precision highp float; uniform sampler2D tMap; varying vec2 vUv; void main() { vec4 color = texture2D(tMap, vUv); if (color.a < 0.1) discard; gl_FragColor = color; }`,
                    uniforms: { tMap: { value: texture } },
                    transparent: true
                });
                this.mesh = new Mesh(this.gl, { geometry, program });
                const aspect = width / height;
                const textHeight = this.plane.scale.y * 0.15;
                const textWidth = textHeight * aspect;
                this.mesh.scale.set(textWidth, textHeight, 1);
                this.mesh.position.y = -this.plane.scale.y * 0.5 - textHeight * 0.5 - 0.05;
                this.mesh.setParent(this.plane);
            }
        }

        class Media {
            constructor({ geometry, gl, image, index, length, renderer, scene, screen, text, viewport, bend, textColor, borderRadius = 0, font }) {
                this.extra = 0;
                this.geometry = geometry;
                this.gl = gl;
                this.image = image;
                this.index = index;
                this.length = length;
                this.renderer = renderer;
                this.scene = scene;
                this.screen = screen;
                this.text = text;
                this.viewport = viewport;
                this.bend = bend;
                this.textColor = textColor;
                this.borderRadius = borderRadius;
                this.font = font;
                this.createShader();
                this.createMesh();
                this.createTitle();
                this.onResize();
            }

            createShader() {
                const texture = new Texture(this.gl, { generateMipmaps: true });
                this.program = new Program(this.gl, {
                    depthTest: false,
                    depthWrite: false,
                    vertex: `
                        precision highp float; attribute vec3 position; attribute vec2 uv; uniform mat4 modelViewMatrix; uniform mat4 projectionMatrix; uniform float uTime; uniform float uSpeed; varying vec2 vUv; varying float vSpeed;
                        void main() {
                            vUv = uv; vSpeed = uSpeed; vec3 p = position;
                            p.z = (sin(p.x * 4.0 + uTime) * 1.5 + cos(p.y * 2.0 + uTime) * 1.5) * (0.1 + uSpeed * 0.3);
                            p.x += sin(p.y * 10.0) * uSpeed * 0.05; 
                            gl_Position = projectionMatrix * modelViewMatrix * vec4(p, 1.0);
                        }
                    `,
                    fragment: `
                        precision highp float; uniform vec2 uImageSizes; uniform vec2 uPlaneSizes; uniform sampler2D tMap; uniform float uBorderRadius; uniform float uTime; varying float vSpeed; varying vec2 vUv;
                        float random(vec2 p) { return fract(sin(dot(p.xy ,vec2(12.9898,78.233))) * 43758.5453); }
                        float roundedBoxSDF(vec2 p, vec2 b, float r) { vec2 d = abs(p) - b; return length(max(d, vec2(0.0))) + min(max(d.x, d.y), 0.0) - r; }
                        void main() {
                            vec2 ratio = vec2(min((uPlaneSizes.x / uPlaneSizes.y) / (uImageSizes.x / uImageSizes.y), 1.0), min((uPlaneSizes.y / uPlaneSizes.x) / (uImageSizes.y / uImageSizes.x), 1.0));
                            vec2 uv = vec2(vUv.x * ratio.x + (1.0 - ratio.x) * 0.5, vUv.y * ratio.y + (1.0 - ratio.y) * 0.5);
                            float rgbStrength = vSpeed * 0.02; 
                            vec4 colorR = texture2D(tMap, uv + vec2(rgbStrength, 0.0));
                            vec4 colorG = texture2D(tMap, uv);
                            vec4 colorB = texture2D(tMap, uv - vec2(rgbStrength, 0.0));
                            vec4 color = vec4(colorR.r, colorG.g, colorB.b, 1.0);
                            float noise = random(vUv + uTime);
                            color.rgb += (noise - 0.5) * 0.08; 
                            float d = roundedBoxSDF(vUv - 0.5, vec2(0.5 - uBorderRadius), uBorderRadius);
                            float alpha = 1.0 - smoothstep(-0.002, 0.002, d);
                            gl_FragColor = vec4(color.rgb, alpha * color.a);
                        }
                    `,
                    uniforms: { tMap: { value: texture }, uPlaneSizes: { value: [0, 0] }, uImageSizes: { value: [0, 0] }, uSpeed: { value: 0 }, uTime: { value: 0 }, uBorderRadius: { value: this.borderRadius } },
                    transparent: true
                });
                const img = new Image(); img.crossOrigin = 'anonymous'; img.src = this.image;
                img.onload = () => { texture.image = img; this.program.uniforms.uImageSizes.value = [img.naturalWidth, img.naturalHeight]; };
            }
            createMesh() { this.plane = new Mesh(this.gl, { geometry: this.geometry, program: this.program }); this.plane.setParent(this.scene); }
            createTitle() { this.title = new Title({ gl: this.gl, plane: this.plane, renderer: this.renderer, text: this.text, textColor: this.textColor, font: this.font }); }
            update(scroll, direction) {
                this.plane.position.x = this.x - scroll.current - this.extra;
                const x = this.plane.position.x; const H = this.viewport.width / 2;
                if (this.bend === 0) { this.plane.position.y = 0; this.plane.rotation.z = 0; } 
                else {
                    const B_abs = Math.abs(this.bend); const R = (H * H + B_abs * B_abs) / (2 * B_abs); const effectiveX = Math.min(Math.abs(x), H); const arc = R - Math.sqrt(R * R - effectiveX * effectiveX);
                    if (this.bend > 0) { this.plane.position.y = -arc; this.plane.rotation.z = -Math.sign(x) * Math.asin(effectiveX / R); } 
                    else { this.plane.position.y = arc; this.plane.rotation.z = Math.sign(x) * Math.asin(effectiveX / R); }
                }
                this.speed = scroll.current - scroll.last; this.program.uniforms.uTime.value += 0.04; this.program.uniforms.uSpeed.value = this.speed;
                const planeOffset = this.plane.scale.x / 2; const viewportOffset = this.viewport.width / 2;
                this.isBefore = this.plane.position.x + planeOffset < -viewportOffset; this.isAfter = this.plane.position.x - planeOffset > viewportOffset;
                if (direction === 'right' && this.isBefore) { this.extra -= this.widthTotal; this.isBefore = this.isAfter = false; }
                if (direction === 'left' && this.isAfter) { this.extra += this.widthTotal; this.isBefore = this.isAfter = false; }
            }
            onResize({ screen, viewport } = {}) {
                if (screen) this.screen = screen; if (viewport) { this.viewport = viewport; if (this.plane.program.uniforms.uViewportSizes) this.plane.program.uniforms.uViewportSizes.value = [this.viewport.width, this.viewport.height]; }
                
                // MOBILE TWEAK: Increase scale multiplier on small screens so items aren't tiny
                const isMobile = this.screen.width < 768;
                this.scale = isMobile ? (this.screen.height / 1300) : (this.screen.height / 1500); 
                
                this.plane.scale.y = (this.viewport.height * (900 * this.scale)) / this.screen.height; 
                
                // MOBILE TWEAK: Adjust width base
                const baseWidth = isMobile ? 1200 : 700;
                this.plane.scale.x = (this.viewport.width * (baseWidth * this.scale)) / this.screen.width;
                
                this.plane.program.uniforms.uPlaneSizes.value = [this.plane.scale.x, this.plane.scale.y]; 
                this.padding = 2; 
                this.width = this.plane.scale.x + this.padding; 
                this.widthTotal = this.width * this.length; 
                this.x = this.width * this.index;
            }
        }

        class App {
            constructor(container, { items, bend, textColor, borderRadius, font }) {
                this.container = container; this.scroll = { ease: 0.025, current: 0, target: 0, last: 0 }; this.onCheckDebounce = debounce(this.onCheck.bind(this), 200);
                this.createRenderer(); this.createCamera(); this.createScene(); this.onResize(); this.createGeometry(); this.createMedias(items, bend, textColor, borderRadius, font); this.update(); this.addEventListeners();
            }
            createRenderer() { this.renderer = new Renderer({ alpha: true, antialias: true, dpr: Math.min(window.devicePixelRatio || 1, 2) }); this.gl = this.renderer.gl; this.gl.clearColor(0, 0, 0, 0); this.container.appendChild(this.gl.canvas); }
            createCamera() { this.camera = new Camera(this.gl); this.camera.fov = 45; this.camera.position.z = 20; }
            createScene() { this.scene = new Transform(); }
            createGeometry() { this.planeGeometry = new Plane(this.gl, { heightSegments: 20, widthSegments: 40 }); }
            createMedias(items, bend = 1, textColor, borderRadius, font) {
                this.mediasImages = items.concat(items);
                this.medias = this.mediasImages.map((data, index) => new Media({ geometry: this.planeGeometry, gl: this.gl, image: data.image, index, length: this.mediasImages.length, renderer: this.renderer, scene: this.scene, screen: this.screen, text: data.text, viewport: this.viewport, bend, textColor, borderRadius, font }));
            }
            onTouchDown(e) { this.isDown = true; this.scroll.position = this.scroll.current; this.start = e.touches ? e.touches[0].clientX : e.clientX; }
            onTouchMove(e) { if (!this.isDown) return; const x = e.touches ? e.touches[0].clientX : e.clientX; const distance = (this.start - x) * 0.05; this.scroll.target = this.scroll.position + distance; }
            onTouchUp() { this.isDown = false; this.onCheck(); }
            onWheel(e) { const delta = e.deltaY || e.wheelDelta || e.detail; this.scroll.target += delta * 0.05; this.onCheckDebounce(); }
            onCheck() { if (!this.medias || !this.medias[0]) return; const width = this.medias[0].width; const itemIndex = Math.round(Math.abs(this.scroll.target) / width); const item = width * itemIndex; this.scroll.target = this.scroll.target < 0 ? -item : item; }
            onResize() {
                this.screen = { width: this.container.clientWidth, height: this.container.clientHeight }; this.renderer.setSize(this.screen.width, this.screen.height); this.camera.perspective({ aspect: this.screen.width / this.screen.height });
                const fov = (this.camera.fov * Math.PI) / 180; const height = 2 * Math.tan(fov / 2) * this.camera.position.z; const width = height * this.camera.aspect; this.viewport = { width, height };
                if (this.medias) this.medias.forEach(media => media.onResize({ screen: this.screen, viewport: this.viewport }));
            }
            update() {
                this.scroll.current = lerp(this.scroll.current, this.scroll.target, this.scroll.ease); const direction = this.scroll.current > this.scroll.last ? 'right' : 'left';
                if (this.medias) this.medias.forEach(media => media.update(this.scroll, direction));
                this.renderer.render({ scene: this.scene, camera: this.camera }); this.scroll.last = this.scroll.current; requestAnimationFrame(this.update.bind(this));
            }
            addEventListeners() {
                window.addEventListener('resize', this.onResize.bind(this)); this.container.addEventListener('wheel', this.onWheel.bind(this)); this.container.addEventListener('mousedown', this.onTouchDown.bind(this)); this.container.addEventListener('mousemove', this.onTouchMove.bind(this)); this.container.addEventListener('mouseup', this.onTouchUp.bind(this)); this.container.addEventListener('touchstart', this.onTouchDown.bind(this)); this.container.addEventListener('touchmove', this.onTouchMove.bind(this)); this.container.addEventListener('touchend', this.onTouchUp.bind(this));
            }
        }

        const galleryItems = [
            { image: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=800&auto=format&fit=crop', text: 'Sithan' },
            { image: 'https://images.unsplash.com/photo-1507842217121-9d5908b04c42?w=800&auto=format&fit=crop', text: 'Library' },
            { image: 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=800&auto=format&fit=crop', text: 'Complex' },
            { image: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&auto=format&fit=crop', text: 'Computing' },
            { image: 'https://images.unsplash.com/photo-1525625293386-3f8f99389edd?w=800&auto=format&fit=crop', text: 'Jubilee' },
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('gallery-container');
            new App(container, {
                items: galleryItems,
                bend: 2,
                textColor: '#1a1a1a', 
                borderRadius: 0, /* Square aesthetic */
                font: '800 50px Playfair Display'
            });
            
            // Re-init logos to be safe after DOM load
            initLogo('logoCanvas', '#1a1a1a');
            initLogo('footerLogoCanvas', '#ffffff');
        });
    </script>
</body>
</html>
